# Lumi Agent CD ì›Œí¬í”Œë¡œìš° (GHCR + EC2 ë°°í¬)
#
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” main ë¸Œëžœì¹˜ì— Pushë  ë•Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
# GitHub Actionsì—ì„œ Docker ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ê³  GHCRì— Pushí•œ í›„,
# EC2ì—ì„œëŠ” Pullë§Œ í•˜ì—¬ ë¹ ë¥´ê²Œ ë°°í¬í•©ë‹ˆë‹¤.
#
# GHCR ë°©ì‹ì˜ ìž¥ì :
#   - GitHub Actionsì—ì„œ ë¹Œë“œ â†’ EC2 ë¶€í•˜ ì—†ìŒ
#   - EC2ì—ì„œëŠ” Pullë§Œ í•˜ë©´ ë¨ â†’ ë°°í¬ ì‹œê°„ ë‹¨ì¶• (3ë¶„ â†’ 30ì´ˆ)
#   - ì—¬ëŸ¬ ì„œë²„ ë°°í¬ ì‹œ í•œ ë²ˆë§Œ ë¹Œë“œ
#   - GitHub í†µí•© (ë³„ë„ ê³„ì • ë¶ˆí•„ìš”)
# 
# ì£¼ìš” ë‹¨ê³„:
#   1. GitHub Actionsì—ì„œ Docker ì´ë¯¸ì§€ ë¹Œë“œ
#   2. GHCRì— ì´ë¯¸ì§€ Push
#   3. EC2ì—ì„œ ì´ë¯¸ì§€ Pull
#   4. ì»¨í…Œì´ë„ˆ êµì²´ (ë‹¤ìš´íƒ€ìž„ ìµœì†Œí™”)
#   5. í—¬ìŠ¤ì²´í¬ ë° ë¡¤ë°± (ì‹¤íŒ¨ ì‹œ)
#
# í•„ìš”í•œ GitHub Secrets:
#   - EC2_HOST: EC2 ì¸ìŠ¤í„´ìŠ¤ IP ë˜ëŠ” ë„ë©”ì¸
#   - EC2_SSH_KEY: EC2 SSH ê°œì¸í‚¤ (.pem íŒŒì¼ ë‚´ìš©)
#   - EC2_USERNAME: EC2 SSH ì‚¬ìš©ìžëª… (ë³´í†µ ubuntu)
#   - UPSTAGE_API_KEY: Upstage API í‚¤
#   - SUPABASE_URL: Supabase URL
#   - SUPABASE_KEY: Supabase í‚¤

name: Lumi Agent CD

# TODO 1: íŠ¸ë¦¬ê±° ì„¤ì •
on:
  push:
    branches:
      - main

  # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš© (ê¸´ê¸‰ ë°°í¬/ë¡¤ë°±ìš©)
  workflow_dispatch:
    inputs:
      rollback:
        description: "Rollback to previous version"
        required: false
        type: boolean
        default: false

# TODO 2: GHCR Push ê¶Œí•œ ì„¤ì •
permissions:
  contents: read
  packages: write

# í™˜ê²½ ë³€ìˆ˜
env:
  REGISTRY: ghcr.io
  IMAGE_NAME_BACKEND: ${{ github.repository }}/lumi-agent
  IMAGE_NAME_FRONTEND: ${{ github.repository }}/lumi-frontend

jobs:
  # =========================================================
  # Job 1: Docker ì´ë¯¸ì§€ ë¹Œë“œ & GHCR Push
  # =========================================================
  build-and-push:
    name: Build & Push to GHCR
    runs-on: ubuntu-latest
    # ë¡¤ë°± ì‹œì—ëŠ” ë¹Œë“œ ìŠ¤í‚µ
    if: ${{ !inputs.rollback }}

    outputs:
      backend_image_digest: ${{ steps.backend_build.outputs.digest }}
      frontend_image_digest: ${{ steps.frontend_build.outputs.digest }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Docker Buildx ì„¤ì • (ë©€í‹° í”Œëž«í¼, ìºì‹œ ì§€ì›)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Normalize image names
        run: |
          echo IMAGE_NAME_BACKEND_LOWER=$(echo '${{ env.IMAGE_NAME_BACKEND }}' | tr '[:upper:]' '[:lower:]') >> $GITHUB_ENV
          echo IMAGE_NAME_FRONTEND_LOWER=$(echo '${{ env.IMAGE_NAME_FRONTEND }}' | tr '[:upper:]' '[:lower:]') >> $GITHUB_ENV

      # TODO 3: GHCR ë¡œê·¸ì¸
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ì´ë¯¸ì§€ íƒœê·¸ ìƒì„±
      - name: Extract backend metadata
        id: backend_meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND_LOWER }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest

      - name: Extract frontend metadata
        id: frontend_meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND_LOWER }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest

      - name: Build and Push backend
        id: backend_build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.backend_meta.outputs.tags }}
          labels: ${{ steps.backend_meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and Push frontend
        id: frontend_build
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ steps.frontend_meta.outputs.tags }}
          labels: ${{ steps.frontend_meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Print image info
        run: |
          echo "ðŸ“¦ ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ!"
          echo "Backend tags: ${{ steps.backend_meta.outputs.tags }}"
          echo "Backend digest: ${{ steps.backend_build.outputs.digest }}"
          echo "Frontend tags: ${{ steps.frontend_meta.outputs.tags }}"
          echo "Frontend digest: ${{ steps.frontend_build.outputs.digest }}"

  # =========================================================
  # Job 2: EC2 ë°°í¬ (Pull & Run)
  # =========================================================
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: build-and-push
    # ë¹Œë“œ ì„±ê³µ í›„ ì‹¤í–‰, ë˜ëŠ” ë¡¤ë°± ì‹œ ë°”ë¡œ ì‹¤í–‰
    if: ${{ always() && (needs.build-and-push.result == 'success' || inputs.rollback) }}

    steps:
      - name: Deploy to EC2 (Normal)
        if: ${{ !inputs.rollback }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e

            echo "ðŸš€ ë°°í¬ ì‹œìž‘: ${{ github.sha }}"
            echo "================================"

            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
            REGISTRY="ghcr.io"
            IMAGE_NAME=$(echo "${{ github.repository }}/lumi-agent" | tr '[:upper:]' '[:lower:]')
            FRONTEND_IMAGE_NAME=$(echo "${{ github.repository }}/lumi-frontend" | tr '[:upper:]' '[:lower:]')
            IMAGE_TAG=$(echo "${{ github.sha }}" | cut -c1-7)
            FULL_IMAGE="${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}"
            FRONTEND_FULL_IMAGE="${REGISTRY}/${FRONTEND_IMAGE_NAME}:${IMAGE_TAG}"
            DEPLOY_DIR="/home/${{ secrets.EC2_USERNAME }}/lumi-agent"

            # ì²« ë°°í¬ ì‹œ í´ë” ìžë™ ìƒì„±
            if [ ! -d "$DEPLOY_DIR" ]; then
              echo "ðŸ“ ì²« ë°°í¬: í´ë” ìƒì„± ì¤‘..."
              mkdir -p $DEPLOY_DIR
            fi

            cd $DEPLOY_DIR

            echo "ðŸ“ docker-compose.yml ìƒì„± ì¤‘..."
            cat > docker-compose.yml << 'COMPOSE_EOF'
            services:
              lumi-agent:
                image: ${LUMI_IMAGE:-ghcr.io/owner/repo/lumi-agent:latest}
                container_name: lumi-agent
                restart: unless-stopped
                ports:
                  - "8000:8000"
                env_file:
                  - .env
                healthcheck:
                  test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health/"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 10s
              lumi-frontend:
                image: ${FRONTEND_IMAGE:-ghcr.io/owner/repo/lumi-frontend:latest}
                container_name: lumi-frontend
                restart: unless-stopped
                depends_on:
                  - lumi-agent
                ports:
                  - "3000:3000"
                environment:
                  NEXT_PUBLIC_API_BASE: http://${{ secrets.EC2_HOST }}:8000
                healthcheck:
                  test: ["CMD", "curl", "-f", "http://localhost:3000/"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 20s
            COMPOSE_EOF

            # .env íŒŒì¼ ìƒì„± (GitHub Secretsì—ì„œ ìžë™ ì£¼ìž…)
            echo "ðŸ“ .env íŒŒì¼ ìƒì„± ì¤‘..."
            cat > .env << ENV_EOF
            ENVIRONMENT=production
            DEBUG=false
            UPSTAGE_API_KEY=${{ secrets.UPSTAGE_API_KEY }}
            SUPABASE_URL=${{ secrets.SUPABASE_URL }}
            SUPABASE_KEY=${{ secrets.SUPABASE_KEY }}
            TTS_PROVIDER=elevenlabs
            ELEVEN_API_KEY=${{ secrets.ELEVEN_API_KEY }}
            ELEVEN_VOICE_NAME=Jjeong - Warm, Calm and Measured
            ELEVEN_MODEL_ID=eleven_multilingual_v2
            EDGE_TTS_VOICE=ko-KR-SunHiNeural
            ENV_EOF
            echo "âœ… .env íŒŒì¼ ìƒì„± ì™„ë£Œ!"

            # Docker Compose ëª…ë ¹ì–´ ì„¤ì •
            if ! command -v docker >/dev/null 2>&1; then
              echo "ðŸ³ Docker ë¯¸ì„¤ì¹˜ ê°ì§€: ìžë™ ì„¤ì¹˜ ì§„í–‰..."
              sudo apt-get update
              sudo apt-get install -y ca-certificates curl gnupg
              sudo install -m 0755 -d /etc/apt/keyrings
              curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
              echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo $VERSION_CODENAME) stable" | sudo tee /etc/apt/sources.list.d/docker.list >/dev/null
              sudo apt-get update
              sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
              sudo usermod -aG docker ${{ secrets.EC2_USERNAME }}
              sudo systemctl enable docker
              sudo systemctl start docker
            fi

            if docker compose version &> /dev/null; then
              DOCKER_COMPOSE="docker compose"
            else
              DOCKER_COMPOSE="docker-compose"
            fi

            # í˜„ìž¬ ë²„ì „ ë°±ì—… (ë¡¤ë°±ìš©)
            if [ -f ".current_image" ]; then
              cp .current_image .previous_image
            fi
            if [ -f ".current_frontend_image" ]; then
              cp .current_frontend_image .previous_frontend_image
            fi
            echo "${FULL_IMAGE}" > .current_image
            echo "${FRONTEND_FULL_IMAGE}" > .current_frontend_image

            # Step 1: GHCR ë¡œê·¸ì¸
            echo "ðŸ” GHCR ë¡œê·¸ì¸ ì¤‘..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Step 2: ì´ë¯¸ì§€ Pull (ë¹ ë¦„! 10~20ì´ˆ)
            echo "ðŸ“¦ ì´ë¯¸ì§€ Pull ì¤‘... (ì´ë¯¸ ë¹Œë“œëœ ì´ë¯¸ì§€)"
            docker pull ${FULL_IMAGE}
            docker pull ${FRONTEND_FULL_IMAGE}

            # Step 3: í™˜ê²½ ë³€ìˆ˜ë¡œ ì´ë¯¸ì§€ ì „ë‹¬
            export LUMI_IMAGE=${FULL_IMAGE}
            export FRONTEND_IMAGE=${FRONTEND_FULL_IMAGE}

            # Step 4: ì»¨í…Œì´ë„ˆ êµì²´ (ë‹¤ìš´íƒ€ìž„ ìµœì†Œí™”)
            echo "ðŸ”„ ì»¨í…Œì´ë„ˆ êµì²´ ì¤‘..."
            $DOCKER_COMPOSE up -d --force-recreate

            # Step 5: í—¬ìŠ¤ì²´í¬ (ìµœëŒ€ 60ì´ˆ ëŒ€ê¸°)
            echo "â³ ë°±ì—”ë“œ í—¬ìŠ¤ì²´í¬ ì¤‘..."
            MAX_RETRIES=12
            RETRY_INTERVAL=5
            for i in $(seq 1 $MAX_RETRIES); do
              HTTP_STATUS=$(curl -sL -o /dev/null -w "%{http_code}" http://localhost:8000/api/v1/health/ 2>/dev/null || echo "000")
              if [ "$HTTP_STATUS" -eq 200 ]; then
                echo "âœ… ì„œë²„ ì •ìƒ (HTTP $HTTP_STATUS)"
                break
              fi
              echo "  ì‹œë„ $i/$MAX_RETRIES (HTTP $HTTP_STATUS)..."
              if [ "$i" -eq "$MAX_RETRIES" ]; then
                echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨!"
                $DOCKER_COMPOSE logs --tail=100

                # ìžë™ ë¡¤ë°± ì‹œë„
                if [ -f ".previous_image" ] && [ -f ".previous_frontend_image" ]; then
                  echo "ðŸ”™ ìžë™ ë¡¤ë°± ì‹œë„..."
                  PREV_IMAGE=$(cat .previous_image)
                  PREV_FRONTEND_IMAGE=$(cat .previous_frontend_image)
                  docker pull ${PREV_IMAGE}
                  docker pull ${PREV_FRONTEND_IMAGE}
                  export LUMI_IMAGE=${PREV_IMAGE}
                  export FRONTEND_IMAGE=${PREV_FRONTEND_IMAGE}
                  $DOCKER_COMPOSE up -d --force-recreate
                  echo "âš ï¸ ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±ë¨: ${PREV_IMAGE}, ${PREV_FRONTEND_IMAGE}"
                fi
                exit 1
              fi
              sleep $RETRY_INTERVAL
            done

            echo "â³ í”„ë¡ íŠ¸ì—”ë“œ í—¬ìŠ¤ì²´í¬ ì¤‘..."
            for i in $(seq 1 $MAX_RETRIES); do
              FRONT_STATUS=$(curl -sL -o /dev/null -w "%{http_code}" http://localhost:3000/ 2>/dev/null || echo "000")
              if [ "$FRONT_STATUS" -eq 200 ]; then
                echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ì •ìƒ (HTTP $FRONT_STATUS)"
                break
              fi
              echo "  ì‹œë„ $i/$MAX_RETRIES (HTTP $FRONT_STATUS)..."
              if [ "$i" -eq "$MAX_RETRIES" ]; then
                echo "âŒ í”„ë¡ íŠ¸ì—”ë“œ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨!"
                $DOCKER_COMPOSE logs --tail=100
                exit 1
              fi
              sleep $RETRY_INTERVAL
            done

            # Step 6: ì •ë¦¬ (ì˜¤ëž˜ëœ ì´ë¯¸ì§€ ì‚­ì œ)
            docker image prune -af

            echo "================================"
            echo "ðŸŽ‰ ë°°í¬ ì™„ë£Œ: ${FULL_IMAGE} + ${FRONTEND_FULL_IMAGE}"

      - name: Rollback to previous version
        if: ${{ inputs.rollback }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e

            echo "ðŸ”™ ë¡¤ë°± ì‹œìž‘..."

            cd /home/${{ secrets.EC2_USERNAME }}/lumi-agent

            # Docker Compose ëª…ë ¹ì–´ ì„¤ì •
            if docker compose version &> /dev/null; then
              DOCKER_COMPOSE="docker compose"
            else
              DOCKER_COMPOSE="docker-compose"
            fi

            if [ ! -f ".previous_image" ]; then
              echo "âŒ ì´ì „ ë²„ì „ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤!"
              exit 1
            fi
            if [ ! -f ".previous_frontend_image" ]; then
              echo "âŒ ì´ì „ í”„ë¡ íŠ¸ì—”ë“œ ë²„ì „ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤!"
              exit 1
            fi

            PREV_IMAGE=$(cat .previous_image)
            PREV_FRONTEND_IMAGE=$(cat .previous_frontend_image)
            echo "ë¡¤ë°± ëŒ€ìƒ: ${PREV_IMAGE} + ${PREV_FRONTEND_IMAGE}"

            # GHCR ë¡œê·¸ì¸
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # ì´ì „ ì´ë¯¸ì§€ Pull
            docker pull ${PREV_IMAGE}
            docker pull ${PREV_FRONTEND_IMAGE}

            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ë° ì»¨í…Œì´ë„ˆ êµì²´
            export LUMI_IMAGE=${PREV_IMAGE}
            export FRONTEND_IMAGE=${PREV_FRONTEND_IMAGE}
            $DOCKER_COMPOSE up -d --force-recreate

            # í—¬ìŠ¤ì²´í¬ (retry ë¡œì§ ì¶”ê°€)
            echo "â³ í—¬ìŠ¤ì²´í¬ ì¤‘..."
            MAX_RETRIES=12
            for i in $(seq 1 $MAX_RETRIES); do
              HTTP_STATUS=$(curl -sL -o /dev/null -w "%{http_code}" http://localhost:8000/api/v1/health/ 2>/dev/null || echo "000")
              if [ "$HTTP_STATUS" -eq 200 ]; then
                echo "âœ… ë¡¤ë°± ì„±ê³µ!"
                echo "${PREV_IMAGE}" > .current_image
                echo "${PREV_FRONTEND_IMAGE}" > .current_frontend_image
                exit 0
              fi
              echo "  ì‹œë„ $i/$MAX_RETRIES (HTTP $HTTP_STATUS)..."
              sleep 5
            done
            echo "âŒ ë¡¤ë°± ì‹¤íŒ¨!"
            $DOCKER_COMPOSE logs --tail=50
            exit 1

  # =========================================================
  # Job 3: ì•Œë¦¼ (GitHub Summary)
  # =========================================================
  notify:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy]
    if: always()

    steps:
      - name: Create Summary
        run: |
          echo "## ðŸš€ Lumi Agent ë°°í¬ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # ë¹Œë“œ ê²°ê³¼
          if [ "${{ needs.build-and-push.result }}" == "success" ]; then
            REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
            echo "### âœ… ë¹Œë“œ ì„±ê³µ" >> $GITHUB_STEP_SUMMARY
            echo "- Backend ì´ë¯¸ì§€: \`ghcr.io/${REPO_LOWER}/lumi-agent:$(echo ${{ github.sha }} | cut -c1-7)\`" >> $GITHUB_STEP_SUMMARY
            echo "- Frontend ì´ë¯¸ì§€: \`ghcr.io/${REPO_LOWER}/lumi-frontend:$(echo ${{ github.sha }} | cut -c1-7)\`" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build-and-push.result }}" == "skipped" ]; then
            echo "### â­ï¸ ë¹Œë“œ ìŠ¤í‚µ (ë¡¤ë°± ëª¨ë“œ)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ ë¹Œë“œ ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # ë°°í¬ ê²°ê³¼
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "### âœ… ë°°í¬ ì„±ê³µ" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ ë°°í¬ ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # ìƒì„¸ ì •ë³´
          echo "### ðŸ“‹ ìƒì„¸ ì •ë³´" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ì»¤ë°‹ | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ë¸Œëžœì¹˜ | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ì‹¤í–‰ìž | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ë°©ì‹ | GHCR + EC2 Pull |" >> $GITHUB_STEP_SUMMARY

          # ë¡¤ë°± ì—¬ë¶€
          if [ "${{ inputs.rollback }}" == "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> âš ï¸ **ë¡¤ë°± ëª¨ë“œë¡œ ì‹¤í–‰ë¨**" >> $GITHUB_STEP_SUMMARY
          fi
