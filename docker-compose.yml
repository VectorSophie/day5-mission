# 5강: Docker Compose 설정
# 로컬 개발 및 Production 배포용 컨테이너 설정
#
# 사용법:
#   # 로컬 개발 (빌드 + 실행)
#   docker-compose up --build
#
#   # Production (GHCR 이미지 사용)
#   LUMI_IMAGE=ghcr.io/owner/repo:tag docker-compose up -d
#
#   # 백그라운드 실행
#   docker-compose up -d
#
#   # 로그 확인
#   docker-compose logs -f
#
#   # 종료
#   docker-compose down
#
# 서비스 구성:
#   - lumi-agent: FastAPI 에이전트 서버 (메인)
#   - (Supabase는 클라우드 서비스 사용)
#   - (Redis는 6강에서 추가 예정)

services:
  # =============================================================
  # 메인 에이전트 서비스
  # =============================================================
  lumi-agent:
    image: ${LUMI_IMAGE:-lumi-agent:latest}
    build:
      context: .
      dockerfile: Dockerfile
    container_name: lumi-agent

    # TODO 2: 포트 매핑 (호스트:컨테이너)
    ports:
      - "8000:8000"

    # TODO 3: 환경변수 설정
    env_file:
      - .env
    environment:
      ENVIRONMENT: ${ENVIRONMENT:-development}
      DEBUG: ${DEBUG:-true}
      HOST: 0.0.0.0
      PORT: 8000
      LLM_MODEL: ${LLM_MODEL:-solar-pro2}
      TTS_PROVIDER: ${TTS_PROVIDER:-elevenlabs}
      ELEVEN_API_KEY: ${ELEVEN_API_KEY:-}
      ELEVEN_VOICE_NAME: ${ELEVEN_VOICE_NAME:-Jjeong - Warm, Calm and Measured}
      ELEVEN_MODEL_ID: ${ELEVEN_MODEL_ID:-eleven_multilingual_v2}
      EDGE_TTS_VOICE: ${EDGE_TTS_VOICE:-ko-KR-SunHiNeural}
      UPSTAGE_API_KEY: ${UPSTAGE_API_KEY:-}
      SUPABASE_URL: ${SUPABASE_URL:-}
      SUPABASE_KEY: ${SUPABASE_KEY:-}

    # TODO 4: 헬스체크 및 재시작 정책 설정
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/api/v1/health/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    restart: unless-stopped
